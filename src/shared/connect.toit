import net
import net.x509
import mqtt
import tls

HOST /string ::= "a2hn36ey2yxmvx-ats.iot.eu-west-1.amazonaws.com"
PORT /int    ::= 8883

DEVICE_NAME := "fisk"

TOPIC_CONFIG   ::= "toit/devices/$DEVICE_NAME/config"
TOPIC_LOCK     ::= TOPIC_CONFIG + "/writer"
TOPIC_REVISION ::= TOPIC_CONFIG + "/revision"

// This global variable keeps the network alive so the GC does not close down
// the network connections.
the_network := null

open_socket -> tls.Socket:
  certificate ::= tls.Certificate TOIT_CERT TOIT_PRIVATE_KEY
  if not the_network:
    the_network = net.open
  socket := the_network.tcp_connect HOST PORT
  tls_socket := tls.Socket.client socket
      --server_name=HOST
      --root_certificates=[AWS_ROOT_CERT]
      --certificate=certificate
  tls_socket.handshake
  return tls_socket

open_client client_id/string socket/tls.Socket -> mqtt.Client:
  client := mqtt.Client
      client_id
      mqtt.TcpTransport socket
  return client


AWS_ROOT_CERT/x509.Certificate ::= x509.Certificate.parse """
-----BEGIN CERTIFICATE-----
MIIDQTCCAimgAwIBAgITBmyfz5m/jAo54vB4ikPmljZbyjANBgkqhkiG9w0BAQsFADA5MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6b24gUm9vdCBDQSAxMB4XDTE1MDUyNjAwMDAwMFoXDTM4MDExNzAwMDAwMFowOTELMAkGA1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJvb3QgQ0EgMTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALJ4gHHKeNXjca9HgFB0fW7Y14h29Jlo91ghYPl0hAEvrAIthtOgQ3pOsqTQNroBvo3bSMgHFzZM9O6II8c+6zf1tRn4SWiw3te5djgdYZ6k/oI2peVKVuRF4fn9tBb6dNqcmzU5L/qwIFAGbHrQgLKm+a/sRxmPUDgH3KKHOVj4utWp+UhnMJbulHheb4mjUcAwhmahRWa6VOujw5H5SNz/0egwLX0tdHA114gk957EWW67c4cX8jJGKLhD+rcdqsq08p8kDi1L93FcXmn/6pUCyziKrlA4b9v7LWIbxcceVOF34GfID5yHI9Y/QCB/IIDEgEw+OyQmjgSubJrIqg0CAwEAAaNCMEAwDwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAYYwHQYDVR0OBBYEFIQYzIU07LwMlJQuCFmcx7IQTgoIMA0GCSqGSIb3DQEBCwUAA4IBAQCY8jdaQZChGsV2USggNiMOruYou6r4lK5IpDB/G/wkjUu0yKGX9rbxenDIU5PMCCjjmCXPI6T53iHTfIUJrU6adTrCC2qJeHZERxhlbI1Bjjt/msv0tadQ1wUsN+gDS63pYaACbvXy8MWy7Vu33PqUXHeeE6V/Uq2V8viTO96LXFvKWlJbYK8U90vvo/ufQJVtMVT8QtPHRh8jrdkPSHCa2XV4cdFyQzR1bldZwgJcJmApzyMZFo6IQ6XU5MsI+yMRQ+hDKXJioaldXgjUkK642M4UwtBV8ob2xJNDd2ZhwLnoQdeXeGADbkpyrqXRfboQnoZsG4q5WTP468SQvvG5
-----END CERTIFICATE-----
"""

TOIT_CERT/x509.Certificate ::= x509.Certificate.parse """
-----BEGIN CERTIFICATE-----
MIIDWjCCAkKgAwIBAgIVAMUgifj2DB/z4udNdzqe9Hc3+OM8MA0GCSqGSIb3DQEB
CwUAME0xSzBJBgNVBAsMQkFtYXpvbiBXZWIgU2VydmljZXMgTz1BbWF6b24uY29t
IEluYy4gTD1TZWF0dGxlIFNUPVdhc2hpbmd0b24gQz1VUzAeFw0yMjA0MjExMTU5
MDhaFw00OTEyMzEyMzU5NTlaMB4xHDAaBgNVBAMME0FXUyBJb1QgQ2VydGlmaWNh
dGUwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDvFqLDTAz3spFQHc0u
95RNqiStGY/luvLkh4kNtn6BXg7QxlLgQSdDVghLsnizan2eh7JCXXCirBsKFn1m
mPODrjHwQbjII6dWswMgnQvXfiRAZGO4Vdw8aHfza6FccZhtNHJZPtS9vVLpEeeh
xITeK40bhYEPF6XP0Ol/jE3as/Dfa9/dlabWIFsA9KfWJO8haqMcohPyEJur61HO
s60ddYW0ZoUksj3Ifq5MtPwhBL6jTETvfixoEOyiOvj+DspHfV3a4ziUGoYqqqrb
I2dBwHE1e6ywpPSGl3QFujDqUFGec/F34EWYPT0FBVPZ6f6J2+rjrqzJfpCzxIgf
0ilHAgMBAAGjYDBeMB8GA1UdIwQYMBaAFC1autklenmMfZ5fRDbvPmPjaDn1MB0G
A1UdDgQWBBSj3bfWgNb+P0rJzaiJ6gf2XGFA/jAMBgNVHRMBAf8EAjAAMA4GA1Ud
DwEB/wQEAwIHgDANBgkqhkiG9w0BAQsFAAOCAQEAhY5VrH/hGjk0e40jOBN8bXxD
lIJ2mqJ88RQlcYpUfBA90RQdiSevgWmDwIrveQfNL3wj2stja348anlOZeefHfSh
msT+QwRVFb6PgLH8iIS6Nl2BsKiVTev9xATmOSbjjmRvnV13dQEbDhiheAdOzQoN
pZGu1cnVOsrrHV7NWH2LBXVQpGkZIZXv96cNV4TAfnyIJfelwVNuJPgHKhPbQo6g
lOE8O8kYnFVuVI3Z1MWiRhXX5Qg26MMbqYr+AJgIk8aYfjz682ySkOF5Sx3fRV72
Ye3ibHfdVszBMr4v8n9l68VA6rbvURixlkSSor+CZ7sQkIMZJ+fi5BYKZufWIA==
-----END CERTIFICATE-----
"""

TOIT_PRIVATE_KEY/string ::= """
-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEA7xaiw0wM97KRUB3NLveUTaokrRmP5bry5IeJDbZ+gV4O0MZS4EEnQ1YIS7J4s2p9noeyQl1woqwbChZ9Zpjzg64x8EG4yCOnVrMDIJ0L134kQGRjuFXcPGh382uhXHGYbTRyWT7Uvb1S6RHnocSE3iuNG4WBDxelz9Dpf4xN2rPw32vf3ZWm1iBbAPSn1iTvIWqjHKIT8hCbq+tRzrOtHXWFtGaFJLI9yH6uTLT8IQS+o0xE734saBDsojr4/g7KR31d2uM4lBqGKqqq2yNnQcBxNXussKT0hpd0Bbow6lBRnnPxd+BFmD09BQVT2en+idvq466syX6Qs8SIH9IpRwIDAQABAoIBAFgHm5IQtE2XH83By0RZv+8AkFRzrvnE5Z2jEaFM6jMzsHzKKMWM96nhSVils69LrEjsaYPp54jdmW8TbMST2EVJo/V0HVcDWZ+gdaxSZoPHXA2haN38LwTG6jNkE5t378l1oAygB7B8vsQ15XU4aDttCZ1ygFxQNqrXnsFppVi6ZeukZsKf2sEa6/eKYtkgN28RLPnsHvq3BRHiTpCbmLVlT1SS0Fl+oRI2Yhz9BwYcxK1KAz/8+fO9JfbEOLQtT7P6n3hmIclhZ7BKMSh4YWp/hoPsbFApndtDk0lwhryRDA+RXsFhP+9B4qgbpx/DGzMFhpbFlg+dpXPoyIKutDECgYEA+U88bNZtavUo8LDjFM9zJbAwlg0yM+dQ8/SoT5uE8Jwt9IiaiedWwfyf44wkJTkYlP/ibzDN9PXlgzrRj13B9xXhaKiG405xTJNPixXokCKUo2eELcs6gx6tIHIxkwJOBEtUfAflziHg8QdAdMSkzjhBpOz/thMs8Zz6/hIAUE0CgYEA9YEuNuJWMxWMkbtNfa+Em2J+pk8k7BXNrssQrH02O9N6vPeTqHE0ahzNlJaa2rwArCbwYAZyUrmp9iAS03Anx2dk9y4vU6+XhHlllzOnwW1fRN3pvmAZ8K+N/9Z1Xq9hHtQjBR7W07buFuG3C5Akwb+R5WquviGUuVHV57e5SeMCgYANRMpSgJcSOjoTlVaApQnb16S+V7V0TbthQIQ0uHI63BUWDq8q58UWTfu0gKDr2j4UsAm9ITvU7cFpWpgMqVDJdcCpcU68ilA9Yxm4rVHTWgPPLpM6XLagg+Fy+KDq0hSU5e15LHJuph7ytRAZJt4em5/ixzpU1nBt64zwOMULgQKBgB1lLUpnCVkugFlGqv2ckW0levKg0VPvPGRsbf+pMmAxbyXHIwftHhCCiF79NWdxUUdLlkZ5HyEml+IfbwGgETM//wfVoNcNVEAJZQ+YoMJ5PQn65CzmRtTZwE/ctsryhtdxIQxQ5/oLkjBtMESTKsOEE4z7nBap4Kvbz5fiGK5vAoGAOfypUp/j+00NMz1JHl/ySHfRg9RBNaAhUCsgFvn1YLH7lGkVcU68/FJHIIFLSTJ34liS98o2HH0OL0bYXU7z0XeIxE596x3yesX89+TMv7TFNiFqXUYacfVZy43s6OfIYcQuwUn99LBRCV9GWDcSxhQKvKmewJg9mDRsWs/sifY=
-----END RSA PRIVATE KEY-----
"""
