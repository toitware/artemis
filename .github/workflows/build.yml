# Copyright (C) 2023 Toitware ApS. All rights reserved.

name: Build

on:
  workflow_dispatch:
    inputs:
      upload_service_snapshot:
        description: Upload the service snapshot image to Artemis
        type: boolean
        required: true
        default: false
      sign_macos:
        description: Sign the macOS binary
        type: boolean
        required: true
        default: false
      sign_windows:
        description: Sign the Windows binary
        type: boolean
        required: true
        default: false
  release:
    types: [published]
  push:
    branches:
      - main

env:
  SUPPORTED_SDK_VERSIONS: |
      v2.0.0-alpha.112

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Toit
        shell: bash
        run: |
          SUPPORTED_ARRAY=($SUPPORTED_SDK_VERSIONS)
          if [[ "$(make dev-sdk-version)" != "${SUPPORTED_ARRAY[-1]}" ]]; then
            echo "Test SDK version is not last supported SDK version"
            exit 1
          fi
          export TOIT_VERSION=${SUPPORTED_ARRAY[-1]}

          export DOWNLOAD_DIR="${{ github.workspace }}/downloads"
          echo "DOWNLOAD_DIR=$DOWNLOAD_DIR" >> $GITHUB_ENV

          TOIT_SDK_DIR=$DOWNLOAD_DIR/toit
          echo "TOIT_EXEC=$TOIT_SDK_DIR/bin/toit.run$BIN_EXTENSION" >> $GITHUB_ENV
          echo "TOITC_EXEC=$TOIT_SDK_DIR/bin/toit.compile$BIN_EXTENSION" >> $GITHUB_ENV
          echo "TPKG_EXEC=$TOIT_SDK_DIR/bin/toit.pkg$BIN_EXTENSION" >> $GITHUB_ENV

          TOIT_SDK_BASE_URL=https://github.com/toitlang/toit/releases

          echo "TOIT_SDK_URL=$TOIT_SDK_BASE_URL/download/$TOIT_VERSION/toit-linux.tar.gz" >> $GITHUB_ENV

      - uses: suisei-cn/actions-download-file@v1.3.0
        name: Download Toit
        with:
          url: ${{ env.TOIT_SDK_URL }}
          target: ${{ env.DOWNLOAD_DIR }}

      - name: Extract Toit - Linux
        shell: bash
        run: |
          cd "$DOWNLOAD_DIR"
          tar x -f *.tar.gz

      - name: Install dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -q ninja-build
          ninja --version

      - name: Run cmake
        shell: bash
        run: |
          make rebuild-cmake
          cmake -DTOITC="$TOITC_EXEC" -DTOITPKG="$TPKG_EXEC" -DTOITRUN="$TOIT_EXEC" build

      - name: Build the CLI
        shell: bash
        # Note that we don't deploy the executable from this buildstep as it isn't stripped.
        run: |
          make

      - name: Build release binaries
        shell: bash
        run: |
          mkdir -p out/linux
          $TOITC_EXEC --strip -o out/linux/artemis build/snapshots/artemis.snapshot

          for SYSTEM in windows macos aarch64; do
            if [[ $SYSTEM == "windows" ]]; then
              BIN_EXTENSION=".exe"
            else
              BIN_EXTENSION=""
            fi
            if [[ $SYSTEM == "aarch64" ]]; then
              OS="linux"
              ARCH="arm64"
            elif [[ $SYSTEM == "macos" ]]; then
              OS="darwin"
              ARCH="amd64"
            else
              OS=$SYSTEM
              ARCH="amd64"
            fi
            mkdir -p out/$SYSTEM
            $TOITC_EXEC --strip --arch $ARCH --os $OS \
              -o out/$SYSTEM/artemis$BIN_EXTENSION build/snapshots/artemis.snapshot
          done

      - name: Rename snapshot
        shell: bash
        run: |
          UUID=$(build/bin/snapshot_uuid$BIN_EXTENSION build/snapshots/artemis.snapshot)
          echo "ARTEMIS_UUID=$UUID" >> $GITHUB_ENV
          mv build/snapshots/artemis.snapshot build/snapshots/artemis-$UUID.snapshot

      - name: Sign in to Artemis
        shell: bash
        env:
          ARTEMIS_EMAIL: leon@toit.io
          ARTEMIS_PASSWORD: ${{ secrets.LEON_ARTEMIS_PW }}
        run: |
          # We log in with the Artemis executable.
          # It will set the authentication in the config file which is also
          # used by the uploader.
          build/bin/artemis auth login --email "$ARTEMIS_EMAIL" --password "$ARTEMIS_PASSWORD"

      - name: Upload snapshot to Artemis
        if: github.event_name == 'release' || inputs.upload_service_snapshot
        shell: bash
        run: |
          # No need to cache the snapshots in a local snapshot directory.
          mkdir -p tmp_snapshots
          build/bin/uploader cli-snapshot \
            --snapshot-directory tmp_snapshots \
            build/snapshots/*.snapshot

      - name: Build and upload service images
        if: github.event_name == 'release'
        shell: bash
        run: |
          # No need to cache the snapshots in a local snapshot directory.
          mkdir -p tmp_snapshots
          for version in $SUPPORTED_SDK_VERSIONS; do
            # For each supported SDK version, build the locally checked out
            # version of the service and upload it to Artemis.
            build/bin/uploader service \
                --snapshot-directory tmp_snapshots \
                --sdk-version $version \
                --service-version ${{ github.event.release.tag_name }} \
                --local \
                --force
            build/bin/uploader service \
                --snapshot-directory tmp_snapshots \
                --sdk-version $version \
                --service-version "${{ github.event.release.tag_name }}+O1" \
                --local \
                --optimization-level=1 \
                --force
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: artemis
          path: |
            build/bin/*
            build/snapshots/artemis-${{ env.ARTEMIS_UUID }}.snapshot

      - name: Upload release artifacts
        uses: actions/upload-artifact@v3
        with:
          name: artemis-release-binaries
          path: out/*

  sign_artemis_windows:
    runs-on: windows-signing
    needs: [build]
    if: github.event_name == 'release' || inputs.sign_windows
    steps:
      - name: Clean workspace
        run: |
          rm -Recurse -Force ${{ github.workspace }}\*

      - uses: actions/download-artifact@v3
        with:
          name: artemis-release-binaries
          path: in

      - name: Copy to build
        run: |
          mkdir build/windows
          copy in/windows/artemis.exe build/windows/artemis.exe

      - name: Sign artemis
        working-directory: ./build/windows
        # Signs in place.
        run: |
          signtool sign /debug /n "Toitware ApS" /t http://timestamp.digicert.com/ $PWD/artemis.exe

      - name: Copy signed to out
        run: |
          mkdir out/windows
          copy build/windows/artemis.exe out/windows/artemis.exe

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: artemis-signed-windows
          path: ./out/windows

  sign_artemis_macos:
    runs-on: macos-latest
    needs: [build]
    if: github.event_name == 'release' || inputs.sign_macos
    steps:
      - uses: actions/checkout@v3

      - uses: actions/download-artifact@v3
        with:
          name: artemis-release-binaries
          path: in

      - name: Install dependencies
        run: |
          set -e
          brew install create-dmg
          brew install zip

      - name: Copy to build
        run: |
          mkdir -p build/macos
          cp in/macos/artemis build/macos/artemis

      - name: Setup binary rights
        run: |
          chmod +x build/macos/artemis

      - name: Sign and notarize
        uses: toitlang/action-macos-sign-notarize@v1.0.0
        with:
          certificate: ${{ secrets.MACOS_CERTIFICATE }}
          certificate-password: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          username: ${{ secrets.AC_USERNAME }}
          password: ${{ secrets.AC_PASSWORD }}
          apple-team-id: 33DS2ZRDST
          # Signs in place.
          app-path: build/macos/artemis

      - name: Create out folder
        run: |
          mkdir -p out/macos

      - name: Create a DMG
        run: |
          # Use an empty directory as source so we don't accidentally add other files than the
          # artemis binary.
          set -e
          mkdir empty
          create-dmg \
              --volname "artemis" \
              --add-file artemis build/macos/artemis 0 0 \
              out/macos/artemis.dmg \
              empty

      - name: Create a ZIP
        run: |
          zip -j out/macos/artemis.zip build/macos/artemis

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: artemis-signed-macos
          path: ./out

  update_public:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Checkout release-repo
        uses: actions/checkout@v3
        with:
          repository: toitware/artemis-releases
          path: release-repo
          token: ${{ secrets.LEON_ARTEMIS_RELEASE_PAT }}

      - name: Checkout docs-repo
        uses: actions/checkout@v3
        with:
          repository: toitware/web-docs
          path: docs-repo
          token: ${{ secrets.LEON_ARTEMIS_RELEASE_PAT }}

      - name: Update examples and broker
        shell: bash
        run: |
          rm -rf release-repo/examples
          cp -r public/examples release-repo/examples

          rm -rf release-repo/broker
          cp -r public/supabase_broker release-repo/broker

      - name: Update docs
        shell: bash
        run: |
          rm -rf docs-repo/docs/getstarted/fleet
          cp -r public/docs/fleet docs-repo/docs/getstarted/fleet

      - name: Update SDK versions
        shell: bash
        run: |
          SUPPORTED_ARRAY=($SUPPORTED_SDK_VERSIONS)
          export TOIT_VERSION=${SUPPORTED_ARRAY[-1]}

          sed -i "s/SDK-VERSION/$TOIT_VERSION/g" release-repo/examples/*
          sed -i "s/SDK-VERSION/$TOIT_VERSION/g" docs-repo/docs/getstarted/fleet/*

      - name: Update Artemis versions
        if: github.event_name == 'release'
        shell: bash
        run: |
          export ARTEMIS_VERSION=${{ github.event.release.tag_name }}

          sed -i "s/ARTEMIS-VERSION/$ARTEMIS_VERSION/g" release-repo/examples/*
          sed -i "s/ARTEMIS-VERSION/$ARTEMIS_VERSION/g" docs-repo/docs/getstarted/fleet/*

      - name: Commit and push example and broker
        if: github.event_name == 'release'
        run: |
          cd release-repo
          git config user.name "Leon Gungadin Mogensen"
          git config user.email "leon@toit.io"
          git add .
          git commit -m "Update examples and broker for version ${{ github.event.release.tag_name }}" || true
          git push

      - name: Commit and push docs
        if: github.event_name == 'release'
        run: |
          cd docs-repo
          git config user.name "Leon Gungadin Mogensen"
          git config user.email "leon@toit.io"
          git add .
          git commit -m "Update docs for version ${{ github.event.release.tag_name }}" || true
          git push

  do_release:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    needs: [sign_artemis_windows, sign_artemis_macos, update_public]
    steps:
      - uses: actions/checkout@v3

      - name: Download Linux artifacts
        uses: actions/download-artifact@v3
        with:
          name: artemis-release-binaries
          path: in

      - name: Download signed Windows artifacts
        uses: actions/download-artifact@v3
        with:
          name: artemis-signed-windows
          path: in-win-signed

      - name: Download signed macOS artifacts
        uses: actions/download-artifact@v3
        with:
          name: artemis-signed-macos
          path: in-mac-signed

      - name: Create archives
        shell: bash
        run: |
          mkdir release-assets

          mkdir artemis-linux
          mv in/linux/artemis artemis-linux
          chmod +x artemis-linux/artemis
          tar -czf release-assets/artemis-linux.tar.gz artemis-linux

          mkdir artemis-linux-aarch64
          mv in/aarch64/artemis artemis-linux-aarch64
          chmod +x artemis-linux-aarch64/artemis
          tar -czf release-assets/artemis-linux-aarch64.tar.gz artemis-linux-aarch64

          mkdir artemis-windows
          zip -j release-assets/artemis-windows.zip in-win-signed/artemis.exe

          mkdir artemis-macos
          mv in-mac-signed/macos/artemis.dmg release-assets/artemis.dmg
          mv in-mac-signed/macos/artemis.zip release-assets/artemis-macos.zip

      - name: Upload release artifacts
        uses: actions/upload-artifact@v3
        with:
          name: release-assets
          path: release-assets

      - name: Upload release artifacts as assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file_glob: true
          file: release-assets/*
          tag: ${{ github.ref }}
          overwrite: true

      - name: Create public release
        env:
          GITHUB_TOKEN: ${{ secrets.LEON_ARTEMIS_RELEASE_PAT }}
        run: |
          BODY=$(echo "${{ github.event.release.body }}" | sed 's/ by @.*$//' | sed '/^## Private/,$d')
          gh release create "${{ github.event.release.tag_name }}" \
            -R toitware/artemis-releases \
            -t "${{ github.event.release.name }}" \
            -n "$BODY" \
            release-assets/*
